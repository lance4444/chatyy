services:
  - type: web
    name: chatty-app
    env: node
    buildCommand: |
      # Debug: Show current directory and contents
      echo "=== Current directory: $(pwd) ==="
      ls -la
      
      # Install root dependencies
      echo "=== Installing root dependencies ==="
      npm install --verbose || echo "Root dependencies installation failed"
      
      # Install frontend dependencies
      echo "=== Installing frontend dependencies ==="
      cd frontend
      npm install --include=dev --verbose || echo "Frontend dependencies installation failed"
      
      # Build the frontend
      echo "=== Building frontend ==="
      npx vite build --outDir ../backend/public || (echo "Frontend build failed" && exit 1)
      
      # Verify frontend build
      echo "=== Verifying frontend build ==="
      ls -la ../backend/public || echo "Frontend build directory not found"
      
      # Install backend dependencies
      echo "=== Installing backend dependencies ==="
      cd ../backend
      npm install --verbose || echo "Backend dependencies installation failed"
      
      # Create necessary directories and copy files
      echo "=== Setting up file structure ==="
      mkdir -p /opt/render/frontend
      cp -r public /opt/render/frontend/dist || echo "Failed to copy frontend files"
      
      # Verify files were copied
      echo "=== Verifying copied files ==="
      ls -la /opt/render/frontend/dist || echo "Failed to list copied files"
      
      # Install production dependencies
      echo "=== Installing production dependencies ==="
      npm ci --only=production --verbose || echo "Production dependencies installation failed"
      
      echo "=== Build completed ==="
    startCommand: npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: MONGODB_URI
        fromDatabase:
          name: chatty-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: PORT
        value: 10000
